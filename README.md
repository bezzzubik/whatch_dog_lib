# Система автоматического отключения неисправных блоков микроконтроллера

### Содержание
1. [Проверка перед использованием](#проверка-перед-использованием-библиотеки)
2. [Строение](#строение)
3. [Принцип работы](#принцип-работы)
___

## Проверка перед использованием библиотеки

Перед использованием библиотеки запустите скетч из папки [check_whatchdog_and_eeprom](https://github.com/bezzzubik/whatch_dog_lib/tree/main/check_whatcdog_and_eeprom/main), чтобы проверить, поддерживает ли ваш микроконтроллер whatchdog и eeprom.

Возможные выводы:
*   ```
    Проверка сброшена
    Поменяйте REP на 0 и загрузите скетч повторно
    ```
    Требуется поменять в строке 4 ``#define REP 1`` на ``0`` и запустится проверка.
	___
*   ```
    Микроконтроллер поддерживает whatchdog
    ```
    Требуется сбросить проверку. То есть поменять ``#define REP 0`` на ``1``, запустить, увидеть вывод с прошлого пункта и сменить обратно.
	___
*   ```
    Проверка энергонезависимых переменных...
    Микроконтроллер поддерживает энергонезависимые переменные
    Проверка whatchdog
    Подождите 8 секунд...
    8
    7
    6
    5
    4
    Микроконтроллер поддерживает whatchdog
    ```
    Все системы поддерживаются, библиотеку можно использовать.
	___
*   ```
    Проверка энергонезависимых переменных...
    Микроконтроллер не поддерживает энергонезависимые переменные
    ```
    Микроконтроллер не поддерживает энергонезависимые переменные. Библиотека не может быть использована.
	___
*   ```
    Проверка энергонезависимых переменных...
    Микроконтроллер поддерживает энергонезависимые переменные
    Проверка whatchdog
    Подождите 8 секунд...
    8
    7
    6
    5
    4
    3
    2
    1
    Микроконтроллер не поддерживает whatchdog
    ```
    Микроконтроллер не поддерживает whatchdog timer. В качестве заменителя можно использовать [внешние модули](https://wiki.iarduino.ru/page/storozhevoy-taymer/). Работа библиотеки и проверка на них пока не поддерживается.
___
<br>


## Строение
Библиотека использует стандартные библиотеки arduino ``eeprom.h`` и ``wdt.h``.

Основана на классе WhatchDog. Состав класса:
```C++
class WhatchDog
{
    int countBlock;
    int nowBlock=0;
    void zero_all_blocks();
    void check_start();
    public:
        void whatch_eeprom();
        WhatchDog(int,int);
        bool check_block();
        void start_loop();
        void zero_all_eeprom();
        void prt_countBlock();
	~WhatchDog();
};
```
Разбор методов и переменных класса:
___
* ```int countBlock;```

  Переменная хранит количество блоков, которые используются в программе. Инициализируется в конструкторе WhatchDog, подробнее будет рассмотрено далее.
___
* ```int nowBlock;```

  Переменная хранит номер текущего блока.
___
* ```WhatchDog(int, int);```
  
  Конструктор класса. Подробный код:
    ```C++
    WhatchDog::WhatchDog(int cB=50, int tim)
    {
        nowBlock=0;
        countBlock=cB;
        wdt_disable();
        check_start();
        switch (tim)
        {
            case 15:
                wdt_enable (WDTO_15MS);
                break;
            case 30:
                wdt_enable (WDTO_30MS);
                break;
            case 60:
                wdt_enable (WDTO_60MS);
                break;
            case 120:
                wdt_enable (WDTO_120MS);
                break;
            case 250:
                wdt_enable (WDTO_250MS);
                break;
            case 500:
                wdt_enable (WDTO_500MS);
                break;
            case 1:
                wdt_enable (WDTO_1S);
                break;
            case 2:
                wdt_enable (WDTO_2S);
                break;
            case 4:
                wdt_enable (WDTO_4S);
                break;
            default:
                wdt_enable (WDTO_8S);
                break;
        }
    }
    ```
    Конструктор принимает 2 переменные: ``int cB`` и ``int tim``.
    ___
    Переменная ``int cB`` принимает количество блоков в основной программе. Максимальное записанное значение - 50. После полного прохождения цикла ``loop`` объект класса сам определит количество блоков в программе.
    ___
    Переменная ``int tim`` определяет время wd timer, после истечения которого микроконтроллер перезагрузится, поэтому выбирайте это время с расчетом на то, что за это время должен выполнится самый долгий по времени выполнения блок.
     
    Возможные значения переменной: 
    
    - 1, 2, 4, 8 - установка соответствующего времени в секундах;
    - 15, 30, 60, 120, 250, 500 - установка соответствующего времени в миллисекундах.
___
* ``~WhatchDog();``

  Деструктор класса. Практического применения в данный момент нет.
___
* ```void prt_countBlock();```
  
  Метод, который выводит переменную ``int countBlock`` (кол-во блоков)
___
* ``void whatch_eeprom();``
  
  Метод выводит значение энергонезависимых переменных. Её рактическое применение будет рассмотрено в разделе ["Работа библиотеки"]().
___
* ``bool check_block();``

  Метод возвращает ``True``, если текущий блок не заблокирован, иначе, если в блоке в процессе выполнения программы была обнаружена ошибка и блок был заблокирован, вернет ``False``.
___
* ``void start_loop();``

  Ставится в начале функции ``void loop()``. Обнуляет энергонезависимые переменные, определяет количество блоков программы по текущему значению блока и обнуляет переменную текущего блока.
___
* ``void zero_all_eeprom();``

  Функция обнуляет все энергонезависимые переменные. Требуется для корректной работы библиотеки при перезапуске или первом запуске. Также имеется одноименная функция с таким же функционалом.
___
* ``void zero_all_blocks();``

  Приватный метод класса. Обнуляет энергонезависимые переменные блоков.
___

## Принцип работы
